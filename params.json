{
  "name": "2016mbl wgcna",
  "tagline": "A tutorial for WGCNA at the Neurobiology Course, Marine Biology Laboratory 2016",
  "body": "# Weighted correlation network analysis\r\n\r\n> MBL Neurobiology 2016\r\n> \r\n> Joon An, Sanders Lab, UCSF (<JoonYong.An@ucsf.edu>)\r\n\r\n\r\n![Willsey 2013](https://cbs.asu.edu/sites/default/files/images/Octopus_MBLTeal.jpg)*Image credit from MBL*\r\n\r\nCo-exression network is a systems biology method to describe pattern(s) among genes across samples with multi-dimension information. This tutorial will use a R package, called Weighted correlation network analysis (WGCNA), for co-expression network analysis.\r\n\r\n## Step0. Set-up the current run \r\n\r\nTo do WGCNA, you first need to install WGCNA on your machine. In the R Studio console, please type the following command. The installation of WGCNA requires several R packages and dependency. Also, you need to install some packages for this script. This step will take some time (and often ERRORS).\r\n\r\n~~~R\r\nsource(\"http://bioconductor.org/biocLite.R\") \r\n\r\nbiocLite(c(\"AnnotationDbi\", \"impute\", \"GO.db\", \"preprocessCore\")) \r\n\r\ninstall.packages(\"WGCNA\")\r\n~~~\r\n\r\nNow load packages.\r\n\r\n~~~R\r\nlibrary(WGCNA)\r\nlibrary(igraph) ## Plot networks\r\n#library(GEOquery) ## Automatically get GEO data\r\n#library(biomaRt) ## Annotations from biomaRt (host is set to use Gencode v10)\r\n~~~\r\n\r\nOnce you finished the installation, then you can set up the current run. First, specifiy your working directory, where **input and output data** will be located. Also, set some working enrivorment parameters.\r\n\r\n~~~R\r\noptions(stringsAsFactors=FALSE)\r\n# Number of processes for this script. It depends on your computing power.\r\nallowWGCNAThreads(nThreads = 2) \r\n~~~\r\n\r\n### Download tutorial files\r\nThe tutorial data is located in `Bioinformatics/WGCNA` on the MBL Dropbox. Please download following files in your working directory:\r\n\r\n\r\n* `20160608_kallisto_tpm.txt`\r\n* `sleuth_sample_example.txt`\r\n* `20160605_kallisto_tpm.geneData.txt`\r\n* `data_expression.txt`\r\n\r\n\r\n\r\n## Step1. Load your data \r\n\r\nWGCNA requires a matrix format (aka table). In this tutorial, you will use three matrix data. \r\n\r\n### Load expression profiles\r\nFirst, load an expression profile. This data contains an expression profile, obtained from your RNAseq. After loading this matrix, check the dimension of your data. You can also see the first few lines of the data using the `head` function.\r\n\r\n~~~R\r\ndatExpr <- read.csv('20160608_kallisto_tpm.txt',header=T,sep='\\t') \r\ndim(datExpr)\r\nhead(datExpr)\r\n~~~\r\n\r\n### Load a meta data\r\nThen, load a meta data. This data contains external information regarding samples or experimental conditions - mutant or wile-type, developmental stages, tissue types, etc. Again, this is a matrix format.\r\n\r\n~~~R\r\ndatMeta <- read.csv('sampleInfo.txt',header=T,sep='\\t') \r\nhead(datMeta)\r\n~~~\r\n\r\n### Load a gene data\r\nLastly, load a gene data. This data contains information about genes. Since the expression dataset is based on transcripts, we will collapse the expression data into the gene level.\r\n\r\n~~~R\r\n# Check the number of transcripts and genes\r\n\r\nlength(geneData$target_id); length(unique(geneData$gene_name))\r\n\r\n# Collapse expression values among transcripts from the same gene.\r\n\r\nrownames(datExpr) = geneData$target_id\r\n\r\ncollapseDat <- collapseRows(datET = datExpr,method=\"MaxMean\",\r\n                            rowGroup = geneDat$gene_name,rowID = rownames(datExpr))\r\n~~~\r\n\r\nTo do faster tutorial, we will use the pre-made dataset. Please load the data.\r\n\r\n~~~R\r\ngeneData <- read.csv('20160605_kallisto_tpm.geneData.txt',header=T,sep='\\t')\r\n\r\nhead(geneData)\r\n\r\n~~~\r\n\r\n## Step2. Explore Topology of the Network\r\n\r\nA biological system is a kind of scale-free network, where interactions are not randomly distributed across genes, proteins or any form of interactors, and thus exibits hierachical and structural characteristics. \r\n\r\nGene-expression can be used to describe this using the network concept, in which nodes are genes and edges between nodes exist when gene expression profiles are significantly correlated (coexpressed) across all samples. \r\n\r\nOkay. I will stop writing the book. Perhaps you might want to read some interesting literatures: \r\n\r\n[Network biology: understanding the cell's functional organization, BarabÃ¡si and Oltval, 2004](http://www.ncbi.nlm.nih.gov/pubmed/14735121)\r\n\r\n[Evolution of synapse complexity and diversity. Emes and Grant, 2012](http://www.ncbi.nlm.nih.gov/pubmed/22715880)\r\n\r\n[Systems biology and gene networks in neurodevelopmental and neurodegenerative disorders, Parikshak et al., 2015](http://www.ncbi.nlm.nih.gov/pubmed/26149713)\r\n\r\n\r\n### Find a soft-thresholding power for network construction\r\n\r\nThis step will find scale free topology of the network given a range of multiple soft thresholding powers. The aim of this step is to help you choose an appropriate power for network construction.\r\n\r\n~~~R\r\n# set the powers to examine network topoloy\r\npowers <- seq(1,10,by=1)\r\n\r\nsft <- pickSoftThreshold(t(datExpr),\r\n                         powerVector=powers,\r\n                         corFnc=\"bicor\",networkType=\"signed\")\r\n\r\n\r\n# This will return you a table like below (numbers may not match):\r\n# Power SFT.R.sq slope truncated.R.sq mean.k. median.k. max.k.\r\n# 1    0.635 12.400          0.869 12000.0  1.28e+04  15600\r\n# 2    0.731 13.000          0.651  3630.0  3.74e+03   6140\r\n# 3    0.461  7.000          0.862  1270.0  1.21e+03   2790\r\n# 4    0.130 -0.221          0.691   526.0  4.33e+02   1910\r\n# 5    0.821 -1.580          0.773   266.0  1.70e+02   1580\r\n# 6    0.828 -1.510          0.839   161.0  7.41e+01   1410\r\n# 7    0.816 -1.380          0.876   112.0  3.51e+01   1310\r\n# 8    0.804 -1.280          0.903    85.9  1.82e+01   1240\r\n# 9    0.801 -1.200          0.918    70.3  1.00e+01   1180\r\n# 10    0.792 -1.110          0.946    60.1  5.90e+00   1140\r\n~~~\r\n\r\nNow you plot your result and pick up the power. \r\n\r\n~~~R\r\npar(mfrow = c(1,2)) # Set the plot screen \r\ncex1 = 0.9\r\n\r\n# Scale-free topology fit index as a function of the soft-thresholding power\r\n\r\nplot(sft$fitIndices[,1], -sign(sft$fitIndices[,3])*sft$fitIndices[,2], \r\n\txlab=\"Soft Threshold (power)\", \r\n\tylab=\"Scale Free Topology Model Fit, signed R^2\",type=\"n\",\r\n\tmain = paste(\"Scale independence\"))\r\n\r\ntext(sft$fitIndices[,1], \r\n\t-sign(sft$fitIndices[,3])*sft$fitIndices[,2],\r\n\tlabels=powers,cex=cex1,col=\"red\");\r\n\r\n# Mean connectivity as a function of the soft-thresholding power\r\n\r\nplot(sft$fitIndices[,1], sft$fitIndices[,5],\r\n\txlab=\"Soft Threshold (power)\",\r\n\tylab=\"Mean Connectivity\", type=\"n\", \r\n\tmain = paste(\"Mean connectivity\"))\r\n\r\ntext(sft$fitIndices[,1], sft$fitIndices[,5], \r\n\tlabels=powers, cex=cex1,col=\"red\")\r\n~~~\r\n\r\nChoosing the optimal power is not easy but the general suggestion is to choose a number you see the saturation of the graph. You can read the developer's suggestions. Please have the 6th question: [WGCNA FAQ](https://labs.genetics.ucla.edu/horvath/CoexpressionNetwork/Rpackages/WGCNA/faq.html)  \r\n\r\nNow you can set the power for your network construction\r\n\r\n~~~R\r\npower <- 9\r\n~~~\r\n\r\n## Step3. Construct a co-expression network\r\n\r\n#### Run WGCNA using the semi-automated function\r\n\r\n~~~R\r\nnet <- blockwiseModules(t(datExpr),\r\n\t\tpower=power,\r\n\t\tdeepSplit=2,\r\n\t\tminModuleSize=200,\r\n\t\tminKMEtoStay=0,\r\n\t\tmergeCutHeight=0.50,\r\n\t\tdetectCutHeight=0.99995,\r\n\t\timpute=TRUE,\r\n\t\tcorType=\"bicor\",\r\n\t\tnetworkType=\"signed\",\r\n\t\tpamStage=FALSE,\r\n\t\tverbose=3,saveTOMs=FALSE,\r\n\t\tmaxBlockSize=1000) \r\n~~~\r\n\r\nYou can see the details about parameters. Type this: \r\n\r\n~~~R\r\n?blockwiseModules\r\n~~~\r\n\r\nNow you can check the number of modules in your network and the number of module genes. \r\n\r\n~~~R\r\ntable(net$colors)\r\n\r\n# The result will be like:\r\n# black      blue     brown     green      grey       red turquoise    yellow \r\n# 415      1914       887       749      9519       661      2494       782 \r\n~~~\r\n\r\nModule colours do not have any meaning, except a visual/labelling purpose. \r\n\r\nNote that **GREY IS RESERVED to color genes that are not part of any module**. Do you have the large number of Grey module genes? What would be a reason for this?\r\n\r\n## Step4. Visualize the relationship of modules \r\n\r\n### Get a adjacency matrix for the hierarchical clustering function\r\n\r\nThis step creates an adjacency matrix from an expression profile. This matrix will be used to compute network topology (Topological Overlap Matrix) ([Zhang et al., 2005](https://labs.genetics.ucla.edu/horvath/GeneralFramework/WeightedNetwork2005.pdf))\r\n\r\n~~~R\r\nadjacency = adjacency(t(datExpr), power = power)\r\nTOM = TOMsimilarity(adjacency)\r\ndissTOM = 1-TOM\r\ngeneTree = hclust(as.dist(dissTOM), method = \"average\")\r\n\r\n# Plot\r\nplotDendroAndColors(geneTree, \r\n\t\t\t\t\t\tnet$colors, \r\n\t\t\t\t\t\t\"Dynamic Tree Cut\",\r\n                    dendroLabels = FALSE, \r\n                    hang = 0.03,\r\n                    addGuide = TRUE, \r\n                    guideHang = 0.05,\r\n                    main = \"Gene Dendrogram and Module \t\t\t\t\t\tColors\")\r\n~~~\r\n\r\nYou can also plot a multidimensional scaling plot can show similar information about module relationships in two dimensions. This plots the first two principal components of the distance matrix.\r\n\r\n~~~R\r\npar(mfrow = c(1,1),mar=c(5,4,2,2))\r\n\r\nMEs = net$MEs #the module eigengenes\r\n\r\n# Choose module colors\r\nmoduleColors_idx = unique(net$colors) \r\n\r\ncolnames(MEs) = moduleColors_idx \r\n\r\nMDS = cmdscale(as.dist(distance),2) \r\n\r\nplot(MDS, \r\n\tcol=moduleColors_idx, \r\n\txlab='1st Principle Component', \r\n\tylab='2nd Principle Component',\r\n\txlim=c(-0.5,0.5),ylim=c(-0.4,0.4))\r\n\t\r\ntext(MDS[,1], MDS[,2], \r\n\tmoduleColors_idx, \r\n\tpos= 3, cex=0.8)\r\n~~~\r\n\r\n## Step 5. Characterize modules by external information \r\n\r\nNow, you will examine which external information is related to network modules.\r\n\r\n~~~R\r\n# List your external information\r\ncolnames(datMeta)\r\n\r\n# Choose the genotype for your analysis\r\n# Create a categorical value and add to a new column\r\ndatMeta$mut <- ifelse(datMeta$genotype!=\"ctr_wt\",'red', 'darkblue')\r\n\r\n# Plot\r\nbarplot(MEs$green,col=datMeta$mut,\r\n        width=0.1, xlab='Samples', ylab='Eigen Value', \r\n        names.arg=datMeta$sample,\r\n        las=2,beside = TRUE,\r\n        main='Green Module') \r\n\r\nlegend(\"topright\",inset=c(0.10,0), \r\n       fill=c(\"darkblue\",\"red\"), \r\n       legend=c(\"Controls\",\"Mutants\"))\r\n~~~\r\n\r\n\r\nHere you will test association of network modules with the expression data of head tissues. Create a new column containing categorical values for your external information.\r\n\r\n~~~R\r\n# Again, set your comparison set from external information\r\n\r\ndatMeta$exp <- ifelse(datMeta$genotype!=\"ctr_wt\",1, 0)\r\n\r\n# Calculate correlation between module eigen values and external information\r\n\r\n# net$MEs is the column contains module eigen values across samples\r\n\r\nhead(net$MEs)\r\n\r\nmoduleTraitCor = cor(net$MEs, datMeta$exp, use = \"p\")\r\n\r\nmoduleTraitPvalue = corPvalueStudent(moduleTraitCor, 96)\r\n\r\ntextMatrix = paste(signif(moduleTraitCor, 2),\r\n\t\t\t\t\"(\", signif(moduleTraitPvalue, 1), \r\n\t\t\t\t\")\", sep = \" \")\r\n\r\ndim(textMatrix) = dim(moduleTraitCor)\r\n\r\npar(mar = c(3, 5, 3, 3))\r\n\r\nlabeledHeatmap(Matrix = moduleTraitCor,\r\n               xLabels = \" \", \r\n               yLabels = names(MEs),\r\n               ySymbols = names(MEs), \r\n               colorLabels = FALSE,\r\n               colors = blueWhiteRed(50),\r\n               textMatrix = textMatrix,\r\n               setStdMargins = FALSE,\r\n               cex.text = 0.9,\r\n               zlim = c(-1,1),\r\n               main = paste(\"Module Association with Motor-neuron sample \"))\r\n~~~\r\n\r\n## Step6. Relationship of top module genes\r\n\r\nHere you will do gene-level visualization. One example is to look at the relationship of the top genes with the highest eigen-values of the module. \r\n\r\n~~~R\r\n# Retrieve module colours\r\ntable(net$colors)\r\n\r\nkMEdat <- signedKME(t(datExpr), MEs, corFnc=\"cor\")\r\n\r\ncolnames(kMEdat) <- colnames(MEs)\r\n\r\ncolnames(kMEdat) # module colours\r\n\r\nmod_col = 'turquoise'\r\n\r\nmod_kMEdat <- kMEdat[net$colors==mod_col,]\r\n\r\n# Select the top 100 genes\r\ntopGenes=rank(mod_kMEdat[,mod_col],\r\n\t\t\t\tties.method=\"first\")<=100\r\n\r\ngene.names= rownames(mod_kMEdat)[topGenes]\r\n\r\n# Subset the adjacency matrix\r\nadj <- adjacency[net$colors==mod_col,\r\n\t\t\t\t\tnet$colors==mod_col]\r\n\r\nadj <- adj[topGenes,topGenes]\r\n\r\nquantile(adj)\r\n\r\n# This is optional. I discard few edges with a low correlation value by replacing with 0 value, This will highlight few nodes with high connectivity. If you want to use this option, please remove the hashtag(#) from the sentence below.\r\n# adj[adj<0.001] <- 0\r\n\r\n# Define a graph object for a network plot\r\ng1 <- graph.adjacency(as.matrix(adj),\r\n\t\t\t\t\t\tmode=\"undirected\",\r\n\t\t\t\t\t\tweighted=TRUE,\r\n\t\t\t\t\t\tdiag=FALSE) \r\n\r\n# Create an object for plotting graph\r\npar(mar = c(1, 1, 1, 1))\r\nplot.igraph(g1,\r\n            vertex.size=10, \r\n            vertex.label.dist=0.5,\r\n            vertex.label.font=0.2,\r\n            vertex.color=mod_col,\r\n            edge.color=\"grey\",\r\n            edge.width=E(g1)$weight*100)\r\n~~~\r\n\r\n## Step7. Annotate modules genes with Drosophila Gene Ontology (Web)\r\n\r\nHere you will annotate your module genes by pathway database. Please go to the [Gene Ontology Website](http://geneontology.org/page/go-enrichment-analysis) and copy-and-paste your genes into the box (left) for enrichment text. Alternatively, you can use a R package for this (GO.db). \r\n\r\n~~~R\r\n# Save your gene list into \"topGenes.txt\"\r\nwriteLines(gene.names, 'topGenes.txt',sep='\\n')\r\n\r\n# Save your module genes and do Gene ontology annotation to see which genes are represented in your module.\r\n\r\n# Turquoise\r\ngeneturquoise <- rownames(datExpr)[net$colors==\"turquoise\"]\r\n\r\nwriteLines(geneturquoise,'modGenes_turquoise.txt',sep='\\n')\r\n\r\n# Red Module\r\ngeneRed <- rownames(datExpr)[net$colors==\"red\"]\r\n\r\nwriteLines(geneRed, 'modGenes_Red.txt',sep='\\n')\r\n~~~\r\n\r\n## What you might want to do next\r\n\r\n* Gene set enrichment with the gene list of your interest (e.g. synatic genes)",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}